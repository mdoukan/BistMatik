<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisse Senedi Analizi - BistMatik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Önce jQuery'yi yükle -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Sonra Plotly'yi yükle -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-locale-tr-latest.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 2rem 0;
        }
        
        .container {
            max-width: 1200px;
        }
        
        .card {
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        
        .form-select {
            margin-bottom: 1rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 3rem;
            height: 3rem;
        }
        
        .chart-container {
            width: 100%;
            min-height: 450px;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        #analysisResults .card-body {
            padding: 1.5rem;
            min-height: 500px;
        }
        
        .prediction-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .prediction-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .prediction-value.negative {
            color: #dc3545;
        }
        
        .current-price {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            text-align: center;
            margin-bottom: 1rem;
        }

        #companySelect {
            overflow-y: auto;
            scrollbar-width: thin;
        }
        #companySelect option {
            padding: 8px;
            cursor: pointer;
        }
        #companySelect option:hover {
            background-color: #f8f9fa;
        }
        #stockSearch {
            margin-bottom: 10px;
        }
        
        /* Pricing Popup Styles */
        .pricing-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .pricing-popup-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .pricing-popup-header {
            padding: 20px;
            background-color: #007bff;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pricing-popup-header h3 {
            margin: 0;
            font-weight: bold;
        }
        
        .close-popup-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .pricing-popup-body {
            padding: 30px;
        }
        
        .popup-packages {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .popup-package {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            width: 30%;
            min-width: 200px;
            text-align: center;
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .popup-package:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .popup-package.highlight {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
            transform: scale(1.05);
        }
        
        .popup-package h4 {
            font-weight: bold;
            color: #343a40;
        }
        
        .popup-package .price {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        
        .popup-package .price span {
            font-size: 14px;
            font-weight: normal;
            color: #6c757d;
        }
        
        .popup-package .badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #ffc107;
            color: #212529;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .pricing-popup-footer {
            padding: 20px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .pricing-btn {
            padding: 10px 25px;
            border-radius: 50px;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .pricing-btn.primary-btn {
            background-color: #007bff;
            color: white;
        }
        
        .pricing-btn.secondary-btn {
            background-color: transparent;
            color: #007bff;
            border: 2px solid #007bff;
        }
        
        .pricing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .popup-packages {
                flex-direction: column;
            }
            
            .popup-package {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">BistMatik</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/stock_analysis">Hisse Analizi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/goals">Hedefler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#features">Özellikler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#pricing">Fiyatlandırma</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#about">Hakkımızda</a>
                    </li>
                    {% if user_name %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> {{ user_name }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="/accounts_settings"><i class="fas fa-cog me-2"></i>Hesap Ayarları</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Çıkış Yap</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="/login">Giriş Yap</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/register">Kayıt Ol</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="text-center mb-4">BistMatik Hisse Senedi Analizi</h1>
        
        <div class="card">
            <div class="card-header">Hisse Senedi Seçimi</div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="text" id="stockSearch" class="form-control" placeholder="Hisse ara...">
                </div>
                <select id="companySelect" class="form-select" size="10" style="height: 300px;">
                    <option value="">Hisse Senedi Seçin</option>
                </select>
                
                <div class="loading">
                    <div class="spinner-border loading-spinner text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-2">Veriler yükleniyor...</p>
                </div>
            </div>
        </div>
        
        <div id="analysisResults" style="display: none;">
            <div class="card mb-4">
                <div class="card-header">Fiyat Bilgisi ve Tahmin</div>
                <div class="card-body">
                    <div class="current-price" id="currentPrice">-</div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="prediction-card">
                                <h5>Yarınki Tahmini Fiyat</h5>
                                <div class="prediction-value" id="predictedPrice">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="prediction-card">
                                <h5>Tahmini Değişim</h5>
                                <div class="prediction-value" id="priceChange">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Fiyat Grafiği</div>
                <div class="card-body">
                    <div id="priceChart" class="chart-container"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Teknik Göstergeler</div>
                <div class="card-body">
                    <div id="rsiChart" class="chart-container"></div>
                    <div id="macdChart" class="chart-container"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Model Performansı</div>
                <div class="card-body">
                    <div class="performance-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="trainAccuracy">-</div>
                            <div class="metric-label">Eğitim Doğruluğu</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="testAccuracy">-</div>
                            <div class="metric-label">Test Doğruluğu</div>
                        </div>
                    </div>
                    
                    <div id="featureImportanceChart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Plotly için Türkçe dil desteği ekle
        Plotly.setPlotConfig({
            locale: 'tr',
            displayModeBar: true,
            displaylogo: false,
            responsive: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        });

        // Veriyi global olarak sakla
        let globalChartData = null;
        
        // Giriş yapmamış kullanıcılar için sorgu hakkı yönetimi
        const QUERY_LIMIT_STOCK = 3; // Stock analysis sayfası için sorgu limiti
        
        function checkQueryLimit() {
            // Kullanıcı giriş yapmışsa limiti kontrol etmeye gerek yok
            {% if user_name %}
                return true;
            {% else %}
                // LocalStorage'dan sorgu sayısını al
                let queryCount = localStorage.getItem('stockAnalysisQueryCount');
                
                // İlk kez kullanıyorsa başlat
                if (!queryCount) {
                    queryCount = 0;
                } else {
                    queryCount = parseInt(queryCount);
                }
                
                // Limit kontrolü
                if (queryCount >= QUERY_LIMIT_STOCK) {
                    showPricingPopup();
                    return false;
                }
                
                // Sorgu sayısını güncelle
                localStorage.setItem('stockAnalysisQueryCount', queryCount + 1);
                return true;
            {% endif %}
        }
        
        // Fiyatlandırma pop-up'ını göster
        function showPricingPopup() {
            // Varsa önceki pop-up'ı kaldır
            const existingPopup = document.getElementById('pricingPopup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Pop-up oluştur
            const popup = document.createElement('div');
            popup.id = 'pricingPopup';
            popup.className = 'pricing-popup';
            popup.innerHTML = `
                <div class="pricing-popup-content">
                    <div class="pricing-popup-header">
                        <h3>BistMatik Üyelik Planları</h3>
                        <button class="close-popup-btn">&times;</button>
                    </div>
                    <div class="pricing-popup-body">
                        <p>Ücretsiz kullanım limitiniz doldu. Daha fazla analiz için lütfen premium paketlerimizden birini seçin.</p>
                        <div class="popup-packages">
                            <div class="popup-package">
                                <h4>Başlangıç</h4>
                                <p class="price">20 TL<span>/hafta</span></p>
                                <p>Hisse senedi analizi ve temel tahminler</p>
                            </div>
                            <div class="popup-package highlight">
                                <h4>Profesyonel</h4>
                                <p class="price">50 TL<span>/hafta</span></p>
                                <p>Hisse analizi, hedefler ve altın/gümüş analizi</p>
                                <span class="badge">En Popüler</span>
                            </div>
                            <div class="popup-package">
                                <h4>Premium</h4>
                                <p class="price">100 TL<span>/ay</span></p>
                                <p>Tüm özellikler ve öncelikli destek</p>
                            </div>
                        </div>
                    </div>
                    <div class="pricing-popup-footer">
                        <a href="/register" class="pricing-btn primary-btn">Hemen Üye Ol</a>
                        <a href="/#pricing" class="pricing-btn secondary-btn">Paketleri İncele</a>
                    </div>
    </div>
            `;
            
            // Pop-up'ı sayfaya ekle
            document.body.appendChild(popup);
            
            // Kapatma düğmesi işlevselliği
            popup.querySelector('.close-popup-btn').addEventListener('click', () => {
                popup.remove();
            });
            
            // Sayfa dışı tıklamada kapatma
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        }

        // Şirket listesini yükle
        async function loadCompanies() {
            try {
                const response = await fetch('/get_companies');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const companies = await response.json();
                
                if (!Array.isArray(companies)) {
                    throw new Error('Şirket listesi bir dizi değil!');
                }
                
                const select = document.getElementById('companySelect');
                // Mevcut seçenekleri temizle (ilk seçeneği koru)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Şirketleri alfabetik sırala
                companies.sort();
                
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    select.appendChild(option);
                });

                // Arama fonksiyonunu ekle
                const searchInput = document.getElementById('stockSearch');
                searchInput.addEventListener('input', function(e) {
                    const searchText = e.target.value.toLowerCase();
                    Array.from(select.options).forEach(option => {
                        if (option.value === '') return; // İlk seçeneği atla
                        const shouldShow = option.value.toLowerCase().includes(searchText);
                        option.style.display = shouldShow ? '' : 'none';
                    });
                });

            } catch (error) {
                console.error('Şirket listesi yüklenirken hata oluştu:', error);
                alert('Şirket listesi yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.');
            }
        }

        // Hisse senedi verilerini yükle
        async function loadCompanyData(company) {
            if (!company) return;
            
            // Sorgu limitini kontrol et
            if (!checkQueryLimit()) {
                return;
            }
            
            const loading = document.querySelector('.loading');
            const results = document.getElementById('analysisResults');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            clearCharts();
            
            try {
                console.log(`${company} için veri yükleniyor...`);
                const response = await fetch(`/get_stock_data/${company}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Sunucu hatası:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}\nSunucu yanıtı: ${errorText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                console.log('Alınan veri:', data);
                globalChartData = data;

                // Fiyat bilgilerini güncelle
                updatePriceInfo();

                // Grafikleri çiz
                if (data.close && data.dates) {
                    await drawPriceChart(data.dates, data.close, data.sma_10, data.sma_50);
                } else {
                    console.warn('Fiyat verisi eksik');
                }

                if (data.rsi) {
                    await drawRSIChart(data.dates, data.rsi);
                } else {
                    console.warn('RSI verisi eksik');
                }

                if (data.macd && data.macd_signal) {
                    await drawMACDChart(data.dates, data.macd, data.macd_signal);
                } else {
                    console.warn('MACD verisi eksik');
                }

                // Model performansını göster
                if (data.train_accuracy !== undefined && data.test_accuracy !== undefined) {
                    document.getElementById('trainAccuracy').textContent = 
                        `${(data.train_accuracy * 100).toFixed(2)}%`;
                    document.getElementById('testAccuracy').textContent = 
                        `${(data.test_accuracy * 100).toFixed(2)}%`;
                } else {
                    console.warn('Model performans metrikleri eksik');
                    document.getElementById('trainAccuracy').textContent = 'Veri yok';
                    document.getElementById('testAccuracy').textContent = 'Veri yok';
                }

                // Özellik önemlerini göster
                if (data.feature_importance) {
                    await drawFeatureImportance(data.feature_importance);
                } else {
                    console.warn('Özellik önemleri verisi eksik');
                }

                // Sonuçları göster
                results.style.display = 'block';

            } catch (error) {
                console.error('Veri yükleme hatası:', error);
                alert(`Veri yüklenirken hata oluştu: ${error.message}`);
                
                clearCharts();
                
                document.getElementById('currentPrice').textContent = 'Hata';
                document.getElementById('predictedPrice').textContent = 'Hata';
                document.getElementById('priceChange').textContent = 'Hata';
                document.getElementById('trainAccuracy').textContent = 'Hata';
                document.getElementById('testAccuracy').textContent = 'Hata';
            } finally {
                loading.style.display = 'none';
            }
        }

        function clearCharts() {
            // Tüm grafikleri temizle
            const chartIds = ['priceChart', 'rsiChart', 'macdChart', 'featureImportanceChart'];
            chartIds.forEach(id => {
                const chartElement = document.getElementById(id);
                if (chartElement) {
                    while (chartElement.firstChild) {
                        chartElement.removeChild(chartElement.firstChild);
                    }
                }
            });
        }

        function drawPriceChart(dates, close, sma10, sma50) {
            const priceTrace = {
                x: dates,
                y: close,
                type: 'scatter',
                mode: 'lines',
                name: 'Kapanış Fiyatı',
                line: {color: '#007bff', width: 2}
            };

            const sma10Trace = {
                x: dates,
                y: sma10,
                type: 'scatter',
                mode: 'lines',
                name: '10 Günlük SMA',
                line: {color: '#ff7f0e', width: 1.5}
            };

            const sma50Trace = {
                x: dates,
                y: sma50,
                type: 'scatter',
                mode: 'lines',
                name: '50 Günlük SMA',
                line: {color: '#2ca02c', width: 1.5}
            };

            const layout = {
                title: {
                    text: 'Fiyat Grafiği',
                    font: {size: 24}
                },
                xaxis: {
                    title: 'Tarih',
                    tickformat: '%Y-%m-%d',
                    tickangle: -45,
                    type: 'date',
                    gridcolor: '#f5f5f5',
                    showgrid: true
                },
                yaxis: {
                    title: 'Fiyat (TL)',
                    gridcolor: '#f5f5f5',
                    showgrid: true,
                    tickformat: '.2f'
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    traceorder: 'normal',
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#E2E2E2',
                    borderwidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                hovermode: 'x unified',
                margin: {
                    l: 60,
                    r: 30,
                    t: 50,
                    b: 50
                },
                height: 450,
                autosize: true
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('priceChart', [priceTrace, sma10Trace, sma50Trace], layout, config);
        }

        function drawRSIChart(dates, rsi) {
            const rsiTrace = {
                x: dates,
                y: rsi,
                type: 'scatter',
                mode: 'lines',
                name: 'RSI',
                line: {color: '#d62728', width: 2}
            };

            const layout = {
                title: {
                    text: 'RSI Göstergesi',
                    font: {size: 24}
                },
                xaxis: {
                    title: 'Tarih',
                    tickformat: '%Y-%m-%d',
                    tickangle: -45,
                    type: 'date',
                    gridcolor: '#f5f5f5',
                    showgrid: true
                },
                yaxis: {
                    title: 'RSI Değeri',
                    gridcolor: '#f5f5f5',
                    showgrid: true,
                    range: [0, 100]
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#E2E2E2',
                    borderwidth: 1
                },
                shapes: [
                    {
                        type: 'line',
                        x0: dates[0],
                        x1: dates[dates.length-1],
                        y0: 70,
                        y1: 70,
                        line: {
                            color: 'red',
                            dash: 'dash',
                            width: 1
                        }
                    },
                    {
                        type: 'line',
                        x0: dates[0],
                        x1: dates[dates.length-1],
                        y0: 30,
                        y1: 30,
                        line: {
                            color: 'green',
                            dash: 'dash',
                            width: 1
                        }
                    }
                ],
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                hovermode: 'x unified',
                margin: {
                    l: 60,
                    r: 30,
                    t: 50,
                    b: 50
                },
                height: 450,
                autosize: true
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('rsiChart', [rsiTrace], layout, config);
        }

        function drawMACDChart(dates, macd, macdSignal) {
            const macdTrace = {
                x: dates,
                y: macd,
                type: 'scatter',
                mode: 'lines',
                name: 'MACD',
                line: {color: '#1f77b4', width: 2}
            };

            const signalTrace = {
                x: dates,
                y: macdSignal,
                type: 'scatter',
                mode: 'lines',
                name: 'MACD Sinyal',
                line: {color: '#ff7f0e', width: 1.5}
            };

            const layout = {
                title: {
                    text: 'MACD Göstergesi',
                    font: {size: 24}
                },
                xaxis: {
                    title: 'Tarih',
                    tickformat: '%Y-%m-%d',
                    tickangle: -45,
                    type: 'date',
                    gridcolor: '#f5f5f5',
                    showgrid: true
                },
                yaxis: {
                    title: 'MACD Değeri',
                    gridcolor: '#f5f5f5',
                    showgrid: true,
                    tickformat: '.2f'
                },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#E2E2E2',
                    borderwidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                hovermode: 'x unified',
                margin: {
                    l: 60,
                    r: 30,
                    t: 50,
                    b: 50
                },
                height: 450,
                autosize: true
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('macdChart', [macdTrace, signalTrace], layout, config);
        }

        function drawFeatureImportance(featureImportance) {
            const features = Object.keys(featureImportance);
            const importance = Object.values(featureImportance);

            const trace = {
                x: importance,
                y: features,
                type: 'bar',
                orientation: 'h',
                name: 'Özellik Önemi',
                marker: {
                    color: '#007bff'
                }
            };

            const layout = {
                title: {
                    text: 'Özellik Önemleri',
                    font: {size: 24}
                },
                xaxis: {
                    title: 'Önem Skoru',
                    gridcolor: '#f5f5f5',
                    showgrid: true
                },
                yaxis: {
                    title: 'Özellik',
                    gridcolor: '#f5f5f5',
                    showgrid: true
                },
                showlegend: false,
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: {
                    l: 150,
                    r: 30,
                    t: 50,
                    b: 50
                },
                height: 450,
                autosize: true
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('featureImportanceChart', [trace], layout, config);
        }

        // Fiyat bilgilerini güncelle
        function updatePriceInfo() {
            const currentPriceElement = document.getElementById('currentPrice');
            const predictedPriceElement = document.getElementById('predictedPrice');
            const priceChangeElement = document.getElementById('priceChange');
            
            const currencySymbol = globalChartData.currency === 'USD' ? '$' : '₺';
            const unitText = globalChartData.unit ? `/${globalChartData.unit}` : '';
            
            // Güncel fiyat
            currentPriceElement.textContent = `${currencySymbol}${globalChartData.current_price.toFixed(2)}${unitText}`;
            
            // Tahmini fiyat
            predictedPriceElement.textContent = `${currencySymbol}${globalChartData.predicted_price.toFixed(2)}${unitText}`;
            
            // Değişim
            const percentChange = (globalChartData.price_change * 100).toFixed(2);
            priceChangeElement.textContent = `${percentChange}%`;
            
            if (globalChartData.price_change > 0) {
                priceChangeElement.classList.add('positive');
                priceChangeElement.classList.remove('negative');
            } else if (globalChartData.price_change < 0) {
                priceChangeElement.classList.add('negative');
                priceChangeElement.classList.remove('positive');
            }
        }

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', () => {
            // Plotly'nin yüklendiğinden emin ol
            if (typeof Plotly === 'undefined') {
                console.error('Plotly yüklenemedi!');
                alert('Grafik kütüphanesi yüklenemedi. Lütfen sayfayı yenileyin.');
                return;
            }

            loadCompanies();
            
            const companySelect = document.getElementById('companySelect');
            if (companySelect) {
                companySelect.addEventListener('change', (e) => {
                    loadCompanyData(e.target.value);
                });
            }

            // Pencere boyutu değiştiğinde grafikleri yeniden çiz
            window.addEventListener('resize', () => {
                if (globalChartData) {
                    const data = globalChartData;
                    if (data.close && data.dates) drawPriceChart(data.dates, data.close, data.sma_10, data.sma_50);
                    if (data.rsi) drawRSIChart(data.dates, data.rsi);
                    if (data.macd && data.macd_signal) drawMACDChart(data.dates, data.macd, data.macd_signal);
                    if (data.feature_importance) drawFeatureImportance(data.feature_importance);
                }
            });
        });
    </script>
</body>
</html> 