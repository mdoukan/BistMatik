<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portföyüm - BistMatik</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .portfolio-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .portfolio-card:hover {
            transform: translateY(-5px);
        }
        .portfolio-header {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
        }
        .portfolio-body {
            padding: 20px;
        }
        .stock-item {
            border-left: 4px solid #5B86E5;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .progress-card {
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress-header {
            background: linear-gradient(135deg, #36D1DC, #5B86E5);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
        }
        .progress-body {
            padding: 20px;
            background-color: white;
        }
        .progress-bar-custom {
            height: 25px;
            border-radius: 15px;
            margin-top: 10px;
        }
        .card-body {
            padding: 20px;
            min-height: 300px;
        }
        .chart-container {
            height: 300px;
            width: 100%;
            position: relative;
            margin-bottom: 20px;
        }
        canvas#portfolioDistributionChart, 
        canvas#portfolioPerformanceChart {
            width: 100% !important;
            height: 100% !important;
            min-height: 250px;
        }
        #distributionChartContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">BistMatik</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/stock_analysis">Hisse Analizi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/goals">Hedefler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/portfolio">Portföyüm</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> {{ user_name }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="/portfolio"><i class="fas fa-chart-line me-2"></i>Portföyüm</a></li>
                            <li><a class="dropdown-item" href="/accounts_settings"><i class="fas fa-cog me-2"></i>Hesap Ayarları</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Çıkış Yap</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h1 class="text-center mb-5">Portföy Takibi</h1>
        
        <div class="row">
            <!-- Sol Taraf - Hedef İlerleme -->
            <div class="col-md-4">
                <div class="progress-card">
                    <div class="progress-header">
                        <h3>Hedef İlerlemesi</h3>
                    </div>
                    <div class="progress-body">
                        <h4 id="currentTarget">Hedef: <span>30,000 TL</span></h4>
                        <h5 id="currentValue">Mevcut: <span>18,500 TL</span></h5>
                        
                        <div class="progress progress-bar-custom">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">60%</div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Günlük Performans</h5>
                            <div id="dailyReturn" class="fs-4 text-success">+2.5%</div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Toplam Kar/Zarar</h5>
                            <div id="totalReturn" class="fs-4 text-success">+8,500 TL</div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="card-title mb-0">Portföy Dağılımı</h4>
                    </div>
                    <div class="card-body" id="distributionChartContainer" style="height: 300px; position: relative;">
                        <!-- Grafik buraya yüklenecek -->
                    </div>
                </div>
            </div>
            
            <!-- Sağ Taraf - Portföy Detayı -->
            <div class="col-md-8">
                <div class="portfolio-card">
                    <div class="portfolio-header">
                        <h3>Portföy Detayı</h3>
                    </div>
                    <div class="portfolio-body">
                        <div id="portfolioStocks">
                            <!-- Hisseler JavaScript ile dinamik olarak eklenecek -->
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="card-title mb-0">Portföy Performansı</h4>
                    </div>
                    <div class="card-body" id="performanceChartContainer" style="height: 300px; position: relative;">
                        <!-- Grafik buraya yüklenecek -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery ve Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Google Charts Kütüphanesi -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <script>
        let portfolioData = null;  // Global değişken olarak ekle
        
        // Google Charts'ı yükle
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(function() {
            console.log('Google Charts yüklendi');
            fetchPortfolioData();
        });
        
        function fetchPortfolioData() {
            console.log('Portföy verileri alınıyor...');
            // API'den portföy verilerini al
            fetch('/api/portfolio')
                .then(response => response.json())
                .then(data => {
                    console.log('Portföy verileri alındı:', data);
                    // Global değişkene kaydet
                    portfolioData = data;
                    
                    // Portföy verilerini güncelle
                    updatePortfolioView(data);
                    
                    // Grafikleri oluştur
                    createPortfolioDistributionChart(data);
                    createPortfolioPerformanceChart(data);
                })
                .catch(error => {
                    console.error('Portföy verileri alınırken hata oluştu:', error);
                });
        }
        
        function updatePortfolioView(data) {
            // Portföy hedefini ve ilerlemeyi güncelle
            if (data.target) {
                document.querySelector('#currentTarget span').textContent = new Intl.NumberFormat('tr-TR').format(data.target) + ' TL';
                document.querySelector('#currentValue span').textContent = new Intl.NumberFormat('tr-TR').format(data.currentValue) + ' TL';
                
                // İlerleme çubuğunu güncelle
                const progressPercentage = (data.currentValue / data.target) * 100;
                const progressBar = document.querySelector('.progress-bar');
                progressBar.style.width = progressPercentage + '%';
                progressBar.textContent = progressPercentage.toFixed(1) + '%';
                
                // Kar/zarar bilgilerini güncelle
                const dailyReturn = document.getElementById('dailyReturn');
                const totalReturn = document.getElementById('totalReturn');
                
                if (data.dailyReturn > 0) {
                    dailyReturn.className = 'fs-4 text-success';
                    dailyReturn.textContent = '+' + data.dailyReturn + '%';
                } else {
                    dailyReturn.className = 'fs-4 text-danger';
                    dailyReturn.textContent = data.dailyReturn + '%';
                }
                
                const totalReturnValue = data.currentValue - data.initialValue;
                if (totalReturnValue > 0) {
                    totalReturn.className = 'fs-4 text-success';
                    totalReturn.textContent = '+' + new Intl.NumberFormat('tr-TR').format(totalReturnValue) + ' TL';
                } else {
                    totalReturn.className = 'fs-4 text-danger';
                    totalReturn.textContent = new Intl.NumberFormat('tr-TR').format(totalReturnValue) + ' TL';
                }
            }
            
            // Portföy hisselerini güncelle
            if (data.stocks && data.stocks.length > 0) {
                const stocksContainer = document.getElementById('portfolioStocks');
                stocksContainer.innerHTML = '';
                
                data.stocks.forEach(stock => {
                    const stockDiv = document.createElement('div');
                    stockDiv.className = 'stock-item';
                    
                    const returnClass = stock.return > 0 ? 'text-success' : 'text-danger';
                    const returnSymbol = stock.return > 0 ? '+' : '';
                    
                    stockDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">${stock.name} (${stock.code})</h5>
                                <p class="mb-0">Yatırım: ${new Intl.NumberFormat('tr-TR').format(stock.amount)} TL (${stock.percentage}%)</p>
                            </div>
                            <div class="text-end">
                                <div class="${returnClass}">${returnSymbol}${stock.return}%</div>
                                <div class="text-muted">Son Fiyat: ${stock.lastPrice} TL</div>
                            </div>
                        </div>
                    `;
                    
                    stocksContainer.appendChild(stockDiv);
                });
            } else {
                document.getElementById('portfolioStocks').innerHTML = '<p class="text-center text-muted">Henüz portföyünüzde hisse bulunmuyor.</p>';
            }
        }
        
        function createPortfolioDistributionChart(data) {
            console.log('Dağılım grafiği oluşturuluyor...');
            const chartContainer = document.getElementById('distributionChartContainer');
            
            // Container'ı temizle
            chartContainer.innerHTML = '';
            
            // Veri kontrolü
            if (!data || !data.stocks || data.stocks.length === 0) {
                chartContainer.innerHTML = '<div class="text-center text-muted">Henüz portföyünüzde hisse bulunmuyor.</div>';
                return;
            }
            
            // API yanıtını komple debug için yazdıralım
            console.log('Tüm API yanıtı:', JSON.stringify(data));
            
            try {
                console.log('Hisseler:', data.stocks);
                
                // En sade veri hazırlama
                const chartData = [['Hisse', 'Miktar']];
                
                // Verileri doğrudan ekle - miktar/tutar ne olursa
                data.stocks.forEach(stock => {
                    const amount = parseFloat(stock.amount || 1);
                    console.log(`${stock.code}: ${amount} TL`);
                    chartData.push([stock.code, amount]);
                });
                
                // Google Charts veri tablosu oluştur
                const dataTable = google.visualization.arrayToDataTable(chartData);
                
                // En basit pasta grafiği
                const options = {
                    title: 'Portföy Dağılımı',
                    legend: 'bottom'
                };
                
                // Grafik oluştur - En sade haliyle
                console.log('Google Charts veri tablosu:', dataTable);
                const chart = new google.visualization.PieChart(chartContainer);
                chart.draw(dataTable, options);
                
                console.log('Dağılım grafiği tamamlandı');
                
            } catch (error) {
                console.error('Grafik oluşturulurken hata:', error);
                chartContainer.innerHTML = `
                    <div class="text-center text-danger">
                        <p>Grafik oluşturulurken hata oluştu:</p>
                        <pre>${error.message}</pre>
                        <p>Hata yığını:</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        function createPortfolioPerformanceChart(data) {
            console.log('Performans grafiği oluşturuluyor...');
            const chartContainer = document.getElementById('performanceChartContainer');
            
            // Veri kontrolü
            if (!data || !data.performanceHistory || data.performanceHistory.length === 0) {
                chartContainer.innerHTML = '<div class="text-center text-muted">Henüz performans geçmişi bulunmuyor.</div>';
                return;
            }
            
            try {
                // Veri hazırla - Google Charts formatına dönüştür
                const chartData = [['Tarih', 'Değer']];
                data.performanceHistory.forEach(record => {
                    chartData.push([record.date, record.value]);
                });
                
                // Google Charts veri tablosu oluştur
                const dataTable = google.visualization.arrayToDataTable(chartData);
                
                // Grafik seçenekleri
                const options = {
                    title: 'Portföy Değeri (TL)',
                    curveType: 'function',
                    legend: { position: 'bottom' },
                    chartArea: { width: '90%', height: '70%' },
                    colors: ['#36b9cc'],
                    vAxis: {
                        format: '#,### TL'
                    }
                };
                
                // Grafik oluştur
                const chart = new google.visualization.LineChart(chartContainer);
                chart.draw(dataTable, options);
                
                console.log('Performans grafiği başarıyla oluşturuldu');
                
                // Sayfa boyutu değiştiğinde grafiği yeniden çiz
                $(window).resize(function() {
                    chart.draw(dataTable, options);
                });
                
            } catch (error) {
                console.error('Grafik oluşturulurken hata:', error);
                chartContainer.innerHTML = '<div class="text-center text-danger">Grafik oluşturulurken hata oluştu.</div>';
            }
        }
        
        // Global resize handler
        $(window).resize(function() {
            if (portfolioData) {
                setTimeout(function() {
                    createPortfolioDistributionChart(portfolioData);
                    createPortfolioPerformanceChart(portfolioData);
                }, 200);
            }
        });
    </script>
</body>
</html> 